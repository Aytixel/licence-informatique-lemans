const search_params=new URLSearchParams(location.search);let level=search_params.get("level"),group=search_params.get("group");const study_level_list_element=document.getElementById("study-level"),place_list_element=document.getElementById("place"),room_list_element=document.getElementById("room"),menu_button_element=document.getElementById("menu-button"),menu_element=document.getElementById("menu"),update_free_room_list=async()=>{try{const e=await fetch("https://api.licence-informatique-lemans.tk/v2/find-free-room.json"),n=await e.json();if(!n?.error){const e=new Intl.DateTimeFormat("default",{timeStyle:"short",timeZone:"UTC"});for(const t in n){const a=document.createElement("summary"),l=document.createElement("details"),o=document.createElement("ul");a.textContent=planning_resources_name[t].name;for(const a of n[t]){const n=document.createElement("div");if(n.textContent=planning_resources_name[t].name_list[a.room],o.append(n),a.time_left){const n=document.createElement("div");n.textContent=`temps restant : ${e.format(new Date(a.time_left))}`,n.classList.add("time-left"),o.append(n)}}l.append(a,o),room_list_element.append(l)}}}catch{}};menu_button_element.addEventListener("mousedown",(e=>e.preventDefault())),menu_button_element.addEventListener("pointerup",(e=>{e.preventDefault(),menu_element.showModal(),update_free_room_list()})),menu_element.addEventListener("pointerup",(e=>{const n=menu_element.getBoundingClientRect();(e.clientX<n.left||e.clientX>n.right||e.clientY<n.top||e.clientY>n.bottom)&&(menu_element.close(),room_list_element.innerHTML="")}));const planning_element=document.getElementsByTagName("planning-viewer")[0],title_element=[...document.getElementsByTagName("h1"),...document.getElementsByTagName("h2")],in_favorites=()=>JSON.parse(localStorage.getItem("favorites")).some((e=>e.level==level&&e.group==group)),load_planning=debounce((e=>{planning_resources_name[e?.level]?.name_list[e?.group]?(planning_element.load(e),title_element[0].textContent=planning_resources_name[e?.level].name,title_element[1].textContent=planning_resources_name[e?.level]?.name_list[e?.group],document.title=`${planning_resources_name[e?.level].name} ${planning_resources_name[e?.level]?.name_list[e?.group]}`):planning_element.reset()}),150),add_empty_days=e=>{const n=new Date(e.end_date);let t=new Date(e.start_date);for(;compare_date(t,n);)e.days.findIndex((e=>!compare_date(e.date,t)))<0&&e.days.push({date:t.toISOString(),lessons:[]}),t=add_days(t,1);return e},merge_new_planning=(e,n)=>{compare_date(n.start_date,e.start_date)>0&&(e.start_date=n.start_date),compare_date(n.end_date,e.end_date)<0&&(e.end_date=n.end_date);for(const t of n.days){const n=e.days.findIndex((e=>!compare_date(e.date,t.date)));n>-1?e.days[n]=t:e.days.push(t)}e.days.sort(((e,n)=>-compare_date(e.date,n.date)))},fecth_planning=async(e,n,t,a)=>{try{const l=await fetch(`https://api.licence-informatique-lemans.tk/v2/planning.json?level=${e}&group=${n}&start=${t.toISOString()}&end=${a.toISOString()}`);return add_empty_days(await l.json())}catch{return null}},update_favorites_planning=async(e=!1)=>{const n=JSON.parse(localStorage.getItem("favorites")),t=await Promise.all(e?[fecth_planning(level,group,keep_only_date(add_days(new Date,-7)),keep_only_date(Date.now()+new Date(0).setMonth(4)))]:n.map((e=>fecth_planning(e.level,e.group,keep_only_date(add_days(new Date,-7)),keep_only_date(Date.now()+new Date(0).setMonth(4))))));for(const e of t)if(e){const n=`${e.level}:${e.group}`,t=JSON.parse(localStorage.getItem(n))||{days:[],...e};merge_new_planning(t,e),localStorage.setItem(n,JSON.stringify(t))}},update_planning=async(e=!1)=>{if("string"!=typeof level||"string"!=typeof group)return void update_favorites_planning();let n;if(in_favorites())await update_favorites_planning(e),n=JSON.parse(localStorage.getItem(`${level}:${group}`));else if(n=await fecth_planning(level,group,e?keep_only_date(add_days(new Date,-7)):planning_element.start_date,e?keep_only_date(add_days(new Date,7)):planning_element.end_date),!e){const e={...planning_element.data};merge_new_planning(e,n),n=e}load_planning(n),e&&update_favorites_planning()},fetch_favorite_planning=async(e,n)=>{localStorage.setItem(`${e}:${n}`,JSON.stringify(await fecth_planning(e,n,keep_only_date(add_days(new Date,-7)),keep_only_date(Date.now()+new Date(0).setMonth(4)))))},switch_planning=(e,n)=>{navigator.onLine||(title_element[0].textContent="Pas d'internet",title_element[1].textContent="rip... faut attendre"),level=e,group=n,update_planning(!0)};window.addEventListener("load",(async()=>{await planning_resources_loaded;const e=e=>{const n=document.createElement("summary"),t=document.createElement("details"),a=document.createElement("ul");n.textContent=planning_resources_name[e].name;for(const n in planning_resources_name[e].name_list){const t=document.createElement("planning-button");t.init(e,n,switch_planning,fetch_favorite_planning),a.append(t)}return t.append(n,a),t};for(const n of planning_resources_type["study-level"])study_level_list_element.append(e(n));for(const n of planning_resources_type.place)place_list_element.append(e(n));if(planning_element.addEventListener("planningfetch",(async e=>{const n={...planning_element.data};let t;e.request>0?(t=await fecth_planning(level,group,planning_element.end_date,keep_only_date(add_days(planning_element.end_date,7))),merge_new_planning(n,t)):(t=await fecth_planning(level,group,keep_only_date(add_days(planning_element.start_date,-7)),planning_element.start_date),merge_new_planning(n,t)),in_favorites()&&localStorage.setItem(`${level}:${group}`,JSON.stringify(n)),load_planning(n)})),"string"==typeof level&&"string"==typeof group?switch_planning(level,group):update_planning(),setInterval(update_planning,36e5),window.addEventListener("popstate",(e=>{e.state&&switch_planning(e.state.level,e.state.group)})),"serviceWorker"in navigator)try{const e=await navigator.serviceWorker.register("/sw.js");e.installing||e.waiting||e.active}catch(e){}}));
