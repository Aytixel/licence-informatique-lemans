const room_list_element=document.getElementById("room"),update_free_room_list=async()=>{if(navigator.onLine){start_loader();try{room_list_element.innerHTML="";const e=await fetch("https://api.licence-informatique-lemans.tk/v2/find-free-room.json"),t=await e.json();if(!t?.error){const e=new Intl.DateTimeFormat("default",{timeStyle:"short",timeZone:"UTC"});for(const n in t){const a=document.createElement("summary"),o=document.createElement("details"),l=document.createElement("ul");a.textContent=planning_resources_name[n].name;for(const a of t[n]){const t=document.createElement("div");if(t.textContent=planning_resources_name[n].name_list[a.room],l.append(t),a.time_left){const t=document.createElement("div");t.textContent=`disponible encore : ${e.format(new Date(a.time_left))}`,t.classList.add("time-left"),l.append(t)}}o.append(a,l),room_list_element.append(o)}}}catch{}end_loader(!1)}};let star_update_free_room_update=()=>{star_update_free_room_update=()=>{},update_free_room_list(),setInterval(update_free_room_list,6e4)};const menu_button_element=document.getElementById("menu-button"),menu_element=document.getElementById("menu");menu_button_element.addEventListener("mousedown",(e=>e.preventDefault())),menu_button_element.addEventListener("touchdown",(e=>e.preventDefault())),menu_button_element.addEventListener("pointerup",(e=>{e.preventDefault(),menu_element.showModal(),star_update_free_room_update()})),menu_element.addEventListener("pointerup",(e=>{const t=menu_element.getBoundingClientRect();(e.clientX<t.left||e.clientX>t.right||e.clientY<t.top||e.clientY>t.bottom)&&menu_element.close()}));const search_params=new URLSearchParams(location.search);let level=search_params.get("level")||localStorage.getItem("history-level"),group=search_params.get("group")||localStorage.getItem("history-group");const planning_element=document.getElementsByTagName("planning-viewer")[0],title_element=[document.getElementsByTagName("h1")[0],document.getElementsByTagName("h2")[0]],in_favorites=()=>JSON.parse(localStorage.getItem("favorites")).some((e=>e.level==level&&e.group==group)),load_planning=debounce((e=>{planning_resources_name[e?.level]?.name_list[e?.group]?(planning_element.load(e),title_element[0].textContent=planning_resources_name[e?.level].name,title_element[1].textContent=planning_resources_name[e?.level]?.name_list[e?.group],document.title=`${planning_resources_name[e?.level].name} ${planning_resources_name[e?.level]?.name_list[e?.group]}`):planning_element.reset()}),150),add_empty_days=e=>{const t=new Date(e.end_date);let n=new Date(e.start_date);const a=new Set(e.days.map((e=>e.date)));for(;compare_date(n,t);){const t=n.toISOString();a.has(t)||e.days.push({date:t,lessons:[]}),n=add_days(n,1)}return e},merge_new_planning=(e,t)=>{compare_date(t.start_date,e.start_date)>0&&(e.start_date=t.start_date),compare_date(t.end_date,e.end_date)<0&&(e.end_date=t.end_date);const n=new Map(e.days.map(((e,t)=>[e.date,t])));for(const a of t.days){const t=n.get(a.date);t?e.days[t]=a:e.days.push(a)}e.days.sort(((e,t)=>-compare_date(e.date,t.date)))},fecth_planning=async(e,t,n,a)=>{if(!navigator.onLine)return null;start_loader();try{const o=await fetch(`https://api.licence-informatique-lemans.tk/v2/planning.json?level=${e}&group=${t}&start=${n.toISOString()}&end=${a.toISOString()}`);return end_loader(),add_empty_days(await o.json())}catch{return end_loader(),null}},update_favorites_planning=async(e=!1)=>{if(!navigator.onLine)return;start_loader();const t=JSON.parse(localStorage.getItem("favorites")),n=await Promise.all(t.map((t=>fecth_planning(t.level,t.group,e?keep_only_date(add_days(new Date,-7)):keep_only_date(new Date),keep_only_date(Date.now()+new Date(0).setMonth(4))))));for(const e of n)if(e){const t=`${e.level}:${e.group}`,n=JSON.parse(localStorage.getItem(t))||{days:[],...e};merge_new_planning(n,e),localStorage.setItem(t,JSON.stringify(n))}end_loader()},update_planning=async(e=!1)=>{if(start_loader(),!navigator.onLine)return load_planning(JSON.parse(localStorage.getItem(`${level}:${group}`))),void end_loader();if("string"!=typeof level||"string"!=typeof group)return update_favorites_planning(),void end_loader();let t;if(in_favorites()){const n=update_favorites_planning();e&&load_planning(JSON.parse(localStorage.getItem(`${level}:${group}`))),await n,t=JSON.parse(localStorage.getItem(`${level}:${group}`))}else if(t=await fecth_planning(level,group,e?keep_only_date(add_days(new Date,-7)):keep_only_date(new Date),e?keep_only_date(add_days(new Date,7)):planning_element.end_date),!e){const e=t;t={...planning_element.data},merge_new_planning(t,e)}load_planning(t),end_loader()},fetch_favorite_planning=async(e,t)=>{navigator.onLine&&(start_loader(),localStorage.setItem(`${e}:${t}`,JSON.stringify(await fecth_planning(e,t,keep_only_date(add_days(new Date,-7)),keep_only_date(Date.now()+new Date(0).setMonth(4))))),end_loader())},switch_planning=(e,t)=>{start_loader(),level==e&&group==t||(level=e,group=t,localStorage.setItem("history-level",level),localStorage.setItem("history-group",group),history.pushState({level:level,group:group},"",location.origin+location.pathname+`?level=${level}&group=${group}`)),navigator.onLine||in_favorites()||(title_element[0].textContent="Pas d'internet",title_element[1].textContent="rip... faut attendre"),update_planning(!0),end_loader()};window.addEventListener("load",(async()=>{await planning_resources_loaded;const e=e=>{const t=document.createElement("summary"),n=document.createElement("details"),a=document.createElement("ul");t.textContent=planning_resources_name[e].name;for(const t in planning_resources_name[e].name_list){const n=document.createElement("planning-button");n.init(e,t,switch_planning,fetch_favorite_planning),a.append(n)}return n.append(t,a),n},t=document.getElementById("study-level");for(const n of planning_resources_type["study-level"])t.append(e(n));const n=document.getElementById("place");for(const t of planning_resources_type.place)n.append(e(t));if(planning_element.addEventListener("planningfetch",(async e=>{if(!navigator.onLine)return;start_loader();const t={...planning_element.data};let n;e.request>0?(n=await fecth_planning(level,group,planning_element.end_date,keep_only_date(add_days(planning_element.end_date,7))),merge_new_planning(t,n)):(n=await fecth_planning(level,group,keep_only_date(add_days(planning_element.start_date,-7)),planning_element.start_date),merge_new_planning(t,n)),in_favorites()&&localStorage.setItem(`${level}:${group}`,JSON.stringify(t)),load_planning(t),end_loader()})),"string"==typeof level&&"string"==typeof group?switch_planning(level,group):update_planning(),setInterval(update_planning,36e5),window.addEventListener("popstate",(e=>{e.state&&switch_planning(e.state.level,e.state.group)})),"serviceWorker"in navigator)try{const e=await navigator.serviceWorker.register("/sw.js");e.installing||e.waiting||e.active}catch(e){}}));
